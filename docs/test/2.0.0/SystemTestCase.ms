# ✅ システムテストケース：Supabase 連携（v1.1.2）

対象：
- 認証（Supabase Auth）
- DailyRecord CRUD（UI ←→ localStorage ←→ Supabase）
- RLS（ユーザーごとのアクセス制御）
- マルチデバイス（PC / スマホ）での動作確認

テスト前提：
- PCブラウザ（ブラウザA）と、スマホブラウザ or 別ブラウザ（ブラウザB）を用意
  - 例：ブラウザA＝Chrome（PC）、ブラウザB＝Safari（スマホ）など
- Supabase プロジェクトに接続済み（`VITE_SUPABASE_URL` / `VITE_SUPABASE_ANON_KEY`）
- Supabase 側：
  - `auth.users` / `app_user` / `daily_record_store` テーブルが作成済み
  - RLS ポリシーが有効（ログインユーザーごとのみ読み書き可能）

---

## 1. 認証まわり

### 1-1. Magic Link ログイン成功（単一デバイス）

**目的**  
Magic Link によるログインが正常に行えること、およびログイン状態が画面上に反映されることを確認。

**前提**  
- Supabase `auth.users` にユーザーA（メールアドレス：userA@example.com）が登録されている。
- ブラウザAは未ログイン状態。

**手順**
1. ブラウザAでアプリを開く。
2. AuthPanel に、ユーザーAのメールアドレスを入力。
3. 「ログインリンク送信」ボタンを押す。
4. ユーザーAのメールを開き、受信した Magic Link をクリック。
5. Magic Link からアプリが開き、トップ画面に遷移する。

**期待結果**
- ログインエラーのトースト / アラートが表示されない。
- AuthPanel に「ログイン中メールアドレス」と `userId` が表示される。
- ブラウザAでページをリロードしても、ログイン状態が維持されている。

**結果記入欄**
- 結果：PASS
- メモ：ブランチ1.1.2において成功。.env.localの設定、supabase側の設定、vercelの設定をそれぞれ実施

---

### 1-2. ログアウト

**目的**  
ログアウト操作によりセッションがクリアされ、画面上の状態も未ログインに戻ることを確認。

**前提**
- テスト 1-1 が PASS 済み（ブラウザAでユーザーAがログイン中）。

**手順**
1. ブラウザAでアプリを開き、AuthPanel を表示。
2. 「ログアウト」ボタンをクリック。

**期待結果**
- AuthPanel のログイン中メールアドレス / `userId` 表示が消える。
- ログインフォーム（メールアドレス入力欄 + ログインリンク送信ボタン）が表示される。
- ページをリロードしても、ログイン状態には戻らず未ログインのままである。

**結果記入欄**
- 結果：PASS
- メモ：ブランチ1.1.2において成功。リロード後もログイン前の状態を確認

---

### 1-3. ログイン状態の維持（リロード / 新規タブ）

**目的**  
ログイン後、同一ブラウザ内でのリロードや新規タブでもセッションが維持されることを確認。

**前提**
- テスト 1-1 が PASS 済み。

**手順**
1. ブラウザAでログイン済みの状態で、ページをリロード。
2. 同じブラウザAで新規タブを開き、同じ URL でアプリを開く。

**期待結果**
- リロード後も AuthPanel 上でログイン中のユーザー情報が表示される。
- 新規タブでも、ログイン中ユーザーの情報が表示されている（再ログイン不要）。

**結果記入欄**
- 結果：PASS
- メモ：ブランチ1.1.2において成功。

---

### 1-4. 無効なメールアドレスでのログイン失敗

**目的**  
登録されていないメールアドレスでログインしようとした場合、適切に失敗することを確認。

**前提**
- Supabase `auth.users` に存在しないメールアドレス（fake@example.com）を用意する。

**手順**
1. ブラウザAでアプリを開く。
2. AuthPanel に `fake@example.com` を入力。
3. 「ログインリンク送信」ボタンを押す。
4. メールボックスを確認し、Magic Link が届かないことを確認する。

**期待結果**
- UI 上で「送信は成功したが、このメールアドレスが実際にログインできるかは別」という挙動があってもよいが、
- 少なくとも、Magic Link 経由でログインしようとしても、アプリ側で `userId` が取得できない（ログイン状態にならない）。

**結果記入欄**
- 結果：PASS
- メモ：ブランチ1.1.2において成功。email rate limit exceded

---

### 1-5. Supabase 側エラー時の挙動確認

**目的**  
Supabase 側でエラーが起きたときに、アプリが異常終了せず、エラーメッセージやログが適切に出ることを確認。

**前提**
- 一時的に `.env` の `VITE_SUPABASE_URL` などをダミー値に変更するか、ネットワークブロック等で擬似的にエラーを発生させる。

**手順**
1. エラーを発生させる設定にした状態でアプリを起動。
2. ログインリンク送信を試みる。

**期待結果**
- 画面全体がクラッシュせず、最低限のエラーメッセージが表示される。
- コンソールにエラー内容が出ている。

**結果記入欄**
- 結果：PASS
- メモ：ブランチ1.1.2において成功。VITE_SUPABASE_URL` などをダミー値に変更した結果、FetchErrorが出力。

---

## 2. DailyRecord CRUD

### 2-1. 新規記録の保存（PC・ユーザーA）

**目的**  
DailyRecord を新規保存したときに、UI / localStorage / Supabase の3箇所で整合して保存されることを確認。

**前提**
- テスト 1-1 が PASS 済み（ブラウザAでユーザーAがログイン中）。
- 対象日付（例：2026-03-01）の記録が、localStorage / Supabase ともに存在しない状態にしておく。

**手順**
1. ブラウザAでフォームを開く。
2. 日付を 2026-03-01 に合わせる。
3. 体重 / 食事 / 運動 / 体調を最小限で入力（例：体重 100.0kg など、分かりやすい値）。
4. 「保存」ボタンを押す。
5. ページをリロードし、再度 2026-03-01 を開く。
6. Supabase ダッシュボードで `daily_record_store` を開き、
   - `user_id = ユーザーA`
   - `record_date = 2026-03-01`
   の行を確認する。

**期待結果**
- 保存ボタン押下時にエラーが表示されない。
- リロード後もフォーム上の内容が変わっていない。
- `daily_record_store` に1行だけレコードが作成されている。
- `record_json` の中身が、フォームで入力した内容と論理的に一致している（DailyRecordAggregate の構造に沿っている）。

**結果記入欄**
- 結果：PASS
- メモ：ブランチ1.1.2において成功。record_jsonへ該当分が保存されている。なおlocalstorageにも同様に保存されている。

---

### 2-2. 既存記録の上書き更新

**目的**  
既に保存済みの記録を更新した場合、Supabase 上の `record_json` が上書きされることを確認。

**前提**
- テスト 2-1 が PASS 済み（2026-03-01 の記録が存在）。

**手順**
1. ブラウザAで 2026-03-01 の記録を開く。
2. 体重など、分かりやすい項目を別の値に変更（例：100.0kg → 101.0kg）。
3. 「保存」ボタンを押す。
4. ページをリロードして同じ日付を開き、更新内容が反映されているか確認。
5. Supabase ダッシュボードで同じ行の `record_json` を確認。

**期待結果**
- `daily_record_store` の該当行（user_id + record_date）は新規行が増えず、同じ行が更新されている（UNIQUE 制約が効いている）。
- `record_json` 内の変更対象フィールドだけが更新された状態になっている。

**結果記入欄**
- 結果：PASS
- メモ：ブランチ1.1.2において成功。朝体重の変更が、record_json・localstorageいずれにも反映されることを確認。

---

### 2-3. 記録の削除

**目的**  
記録削除時に、localStorage / Supabase の両方から対象日付のデータが削除されることを確認。

**前提**
- テスト 2-1 or 2-2 が PASS 済み（2026-03-01 の記録が存在）。

**手順**
1. ブラウザAで 2026-03-01 の記録を開く。
2. UI 上の「削除」操作を行う（削除ボタン等）。
3. 確認ダイアログがあれば承認する。
4. ページをリロードし、再度 2026-03-01 を開く。
5. Supabase ダッシュボードで `daily_record_store` を確認し、該当行の有無を確認。

**期待結果**
- UI 上で、対象日付の入力内容がクリアされる。
- リロード後も、その日付にはデータが表示されない。
- `daily_record_store` から `user_id = ユーザーA & record_date = 2026-03-01` の行が削除されている。

**結果記入欄**
- 結果：PASS
- メモ：ブランチ1.1.2において成功。record_json・localstorageいずれからも削除されていることを確認

---

### 2-4. 日付変更と履歴一覧表示

**目的**  
日付を変更して複数日分を保存・参照したときに、履歴一覧や日付切り替えが正しく動作することを確認。

**前提**
- 複数日（例：2026-03-01〜2026-03-03）に対して、テスト 2-1 の手順を繰り返し、3日分保存しておく。

**手順**
1. 日付を切り替えながら、3日分の入力内容がそれぞれ期待通り表示されるか確認。
2. 履歴一覧（History）画面がある場合は、そこに3件分表示されているか確認。

**期待結果**
- 各日付を開いたときに、対応する内容だけが表示される。
- 「ある日付で編集した内容が別の日付に混ざる」などの不具合がない。

**結果記入欄**
- 結果：PASS / FAIL
- メモ：ブランチ1.1.2において成功。record_json・localstorage、UIいずれでも保存されていることを確認

---

### 2-5. マルチデバイス（PC / スマホ）での同一ユーザー動作

**目的**  
1ユーザーが PC とスマホの両方からログインした場合でも、同じ Supabase データにアクセスでき、相互に整合していることを確認。

**前提**
- ユーザーAのアカウントが存在。
- ブラウザA＝PCブラウザ、ブラウザB＝スマホブラウザ（または別ブラウザ）として用意。
- どちらもクッキー等が独立していること。

**手順**
1. **PC側（ブラウザA）**
   1. ユーザーAでログイン（テスト 1-1 相当）。
   2. 日付を 2026-03-05 に設定し、分かりやすい内容で記録を保存（体重 100.5kg など）。
2. **スマホ側（ブラウザB）**
   1. 同じユーザーAのメールアドレスで Magic Link ログイン。
   2. 日付を 2026-03-05 に設定して開く。
3. 表示内容を確認したのち、スマホ側で内容を変更（例：体重 101.5kg に変更）し、保存。
4. 再度 PC 側（ブラウザA）でページをリロードし、同じ日付を開く。

**期待結果**
- PC とスマホの両方で、同じユーザーAとしてログインできる。
- PC→保存 → スマホ→表示 の時点で、スマホ側に PC で保存した内容が表示される。
- スマホ側で更新→保存した後、PC でリロードすると、その更新内容が反映されている。
- Supabase `daily_record_store` には、ユーザーA + 2026-03-05 の行が1つだけ存在し、その `record_json` が最新の内容になっている。
- 各デバイスの localStorage 状態にかかわらず、最終的なソース・オブ・トゥルースとして Supabase の内容が整合している。

**結果記入欄**
- 結果：PASS
- メモ：ブランチ1.1.2において成功。PC、スマホいずれからも保存した内容が、Supabaseに最新版となることを確認。

---

## 3. RLS（ユーザーごとのアクセス制御）

### 3-1. ユーザーBからユーザーAの記録が見えない

**目的**  
別ユーザーでログインしても、他人の Supabase 記録が一切参照できないことを確認。

**前提**
- ユーザーA / ユーザーB の2アカウントが存在。
- テスト 2-1 などで、ユーザーAとして 2026-03-10 の記録が保存されている。
- `daily_record_store` に `user_id = ユーザーA` & `record_date = 2026-03-10` の行が存在。

**手順**
1. ブラウザAでユーザーBとしてログイン。
2. 日付を 2026-03-10 に設定して記録画面を開く。
3. （可能であれば）Network タブで DailyRecord 読み込みの API レスポンスを確認。

**期待結果**
- UI 上では、ユーザーAの 2026-03-10 のデータは一切表示されない（空、またはユーザーB自身のデータのみ）。
- API レスポンス上も、ユーザーAの `record_json` が含まれていない（RLS によりフィルタされている）。

**結果記入欄**
- 結果：PASS
- メモ：ブランチ1.1.2において成功。localstorage分は参照できてしまうものの、Supabase分は見えないこと確認済。

---

### 3-2. ユーザーBがユーザーAの記録を更新・削除できない

**目的**  
他人の記録に対して更新・削除ができないことを確認。

**前提**
- テスト 3-1 の前提を満たしている。
- API 等で直接叩ける場合は、ユーザーBのトークンを使ってユーザーAのレコードIDを指定する形で試験してもよい（任意）。

**手順（UIベース / 可能な範囲）**
1. ユーザーBでログインした状態で、ユーザーAのデータがある日付を開く。
2. UI 上からはそもそもユーザーAのデータが見えないため、更新・削除操作は行えない。

**期待結果**
- UI 上からは、他ユーザーのデータを操作する導線が存在しない。
- （API レベルのテストを行う場合）ユーザーBトークンで A の行を更新 / 削除しようとすると RLS により拒否される。

**結果記入欄**
- 結果：PASS
- メモ：ブランチ1.1.2において成功。同線は存在しない。

---

## 4. エラー・異常系（CRUDまわり）

### 4-1. Supabase への保存失敗時の挙動

**目的**  
Supabase 側で一時的なエラーが発生した場合に、アプリがどのような挙動をとるか確認（エラーメッセージ、localStorage 側の挙動）。

**前提**
- 一時的に Supabase のネットワークを遮断する、あるいは `daily_record_store` の RLS を厳しめに変更するなどして、保存時にエラーが発生する状況を作る。

**手順**
1. ユーザーAでログイン。
2. 任意の日付の記録を入力し、「保存」を押す。
3. Supabase への送信でエラーが発生するようにする。

**期待結果**
- エラーメッセージが画面上に表示される（サイレント失敗しない）。
- 画面がクラッシュしない。
- localStorage 側の状態がどうなるか（保存される / 保存されない）は仕様どおりになっている。

**結果記入欄**
- 結果：PASS / FAIL
- メモ：

---

### 4-2. ネットワーク断中の挙動

**目的**  
オフライン等でネットワークに接続できない状態で保存を試みたときの挙動を確認。

**前提**
- ブラウザの開発者ツールなどで「オフライン」状態にできること。

**手順**
1. ユーザーAでログイン済みの状態で、ブラウザのネットワークをオフラインに切り替える。
2. 任意の日付の記録を入力し、「保存」を押す。
3. オンラインに戻した後、再度同日付を開いたときの状態を確認。

**期待結果**
- オフライン時の保存でエラーまたは警告が表示される。
- オンライン復帰後に、Supabase 上のデータとの整合がとれている（仕様に従う）。

**結果記入欄**
- 結果：PASS / FAIL
- メモ：

---

## 5. 移行テスト（v2.0.0 移行関数実装後に実施）

### 5-1. 旧履歴 → Supabase への一括移行

**目的**  
localStorage にある既存履歴を、`migrateAllLocalHistoryToSupabase` で Supabase に一括移行できることを確認。

**前提**
- Supabase の `daily_record_store` が空（truncate 済み）。
- localStorage に複数日分の DailyRecord 履歴が存在している。

**手順**
1. ログイン後、`migrateAllLocalHistoryToSupabase(userId)` を実行する（ボタン or コンソール）。
2. Supabase の `daily_record_store` を確認する。
3. フォームで各日付を開き、内容を確認する。

**期待結果**
- `daily_record_store` に、localStorage と同じ日付分だけ行が作成されている。
- 各日付ごとに、フォームに表示される内容が localStorage 側の履歴と一致している。

**結果記入欄**
- 結果：PASS / FAIL
- メモ：

以上。